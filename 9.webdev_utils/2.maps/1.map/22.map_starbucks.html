<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ìŠ¤íƒ€ë²…ìŠ¤ ë§¤ì¥ ê²½ë¡œ í”Œë˜ë„ˆ</title>

    <!-- Leaflet ê¸°ë³¸ CSS/JS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Routing Machine CSS/JS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"
    />
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
            sans-serif;
            margin: 0;
            padding: 0;
        }
        header {
            padding: 12px 16px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }
        h1 {
            font-size: 1.2rem;
            margin: 0 0 4px;
        }
        .subtitle {
            font-size: 0.85rem;
            color: #666;
        }

        .layout {
            display: flex;
            flex-wrap: wrap;
            min-height: calc(100vh - 60px);
        }

        .sidebar {
            flex: 0 0 320px;
            max-width: 400px;
            border-right: 1px solid #ddd;
            padding: 12px;
            font-size: 0.9rem;
        }

        .sidebar h2 {
            font-size: 1rem;
            margin: 0 0 8px;
        }

        .store-list {
            max-height: 220px;
            overflow-y: auto;
            margin-bottom: 8px;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 6px;
        }

        .store-item {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 6px;
            padding: 4px;
            border-radius: 4px;
        }

        .store-item:hover {
            background: #f8f9fa;
        }

        .store-item input[type="checkbox"] {
            margin-top: 3px;
        }

        .store-name {
            font-weight: 600;
        }

        .store-addr {
            font-size: 0.8rem;
            color: #666;
        }

        .selection-summary {
            margin-bottom: 8px;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 6px;
            background: #fafafa;
        }
        .selection-title {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .selection-list {
            font-size: 0.8rem;
            white-space: pre-line;
        }

        .buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 6px;
        }
        .btn {
            padding: 6px 10px;
            font-size: 0.85rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
        }
        .btn-primary {
            background: #007bff;
            border-color: #007bff;
            color: #fff;
        }
        .btn-secondary {
            background: #e9ecef;
        }

        .status {
            font-size: 0.8rem;
            color: #666;
            min-height: 18px;
            margin-bottom: 4px;
        }

        .route-info {
            font-size: 0.8rem;
            color: #333;
            white-space: pre-line;
            border-top: 1px solid #eee;
            padding-top: 4px;
            margin-top: 4px;
        }

        .map-container {
            flex: 1 1 0;
            min-width: 260px;
            height: 520px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ê²½ë¡œ ìˆœë²ˆ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
        .route-index {
            background: #ff6b6b;
            color: #fff;
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid #fff;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
            line-height: 24px;
            width: 24px;
            height: 24px;
        }

        @media (max-width: 768px) {
            .layout {
                flex-direction: column;
            }
            .sidebar {
                max-width: 100%;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
            .map-container {
                height: calc(100vh - 340px);
            }
        }
    </style>
</head>
<body>
<header>
    <h1>ì„œìš¸ ìŠ¤íƒ€ë²…ìŠ¤ ê²½ë¡œ í”Œë˜ë„ˆ</h1>
    <div class="subtitle">
        10ê°œ ë§¤ì¥ ì¤‘ ì›í•˜ëŠ” ê³³ì„ ì„ íƒí•˜ê³ , ì„ íƒ ìˆœì„œëŒ€ë¡œ ë˜ëŠ” ìµœë‹¨ ê±°ë¦¬ ê²½ë¡œë¥¼ ë¹„êµí•´ë³´ì„¸ìš”.
    </div>
</header>

<div class="layout">
    <aside class="sidebar">
        <h2>ë§¤ì¥ ì„ íƒ</h2>
        <div class="store-list" id="store-list"></div>

        <div class="selection-summary">
            <div class="selection-title">í˜„ì¬ ì„ íƒ ìˆœì„œ</div>
            <div id="selected-order" class="selection-list">
                ì„ íƒëœ ë§¤ì¥ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </div>

        <div class="buttons">
            <button class="btn btn-secondary" id="clear-btn">ì„ íƒ í•´ì œ</button>
            <button class="btn btn-primary" id="order-route-btn">ì„ íƒìˆœì„œ ê²½ë¡œ</button>
            <button class="btn btn-primary" id="shortest-route-btn">ìµœë‹¨ê±°ë¦¬ ê²½ë¡œ</button>
        </div>

        <div class="status" id="status"></div>
        <div class="route-info" id="route-info"></div>
    </aside>

    <section class="map-container">
        <div id="map"></div>
    </section>
</div>

<script>
    // ===== 1. ìŠ¤íƒ€ë²…ìŠ¤ ë§¤ì¥ ë°ì´í„° =====
    const stores = [
        {
            id: 1,
            name: "ìŠ¤íƒ€ë²…ìŠ¤ ì„œìš¸ê´‘ì¥ì ",
            address: "ì„œìš¸ ì¤‘êµ¬ ì„ì§€ë¡œ 12",
            lat: 37.5668,
            lng: 126.9786,
        },
        {
            id: 2,
            name: "ìŠ¤íƒ€ë²…ìŠ¤ ëª…ë™ì—­ì ",
            address: "ì„œìš¸ ì¤‘êµ¬ í‡´ê³„ë¡œ 123",
            lat: 37.5610,
            lng: 126.9825,
        },
        {
            id: 3,
            name: "ìŠ¤íƒ€ë²…ìŠ¤ ê°•ë‚¨ì—­ì ",
            address: "ì„œìš¸ ê°•ë‚¨êµ¬ ê°•ë‚¨ëŒ€ë¡œ 390",
            lat: 37.4980,
            lng: 127.0276,
        },
        {
            id: 4,
            name: "ìŠ¤íƒ€ë²…ìŠ¤ ì‹ ì´Œì—­ì ",
            address: "ì„œìš¸ ì„œëŒ€ë¬¸êµ¬ ì—°ì„¸ë¡œ 10",
            lat: 37.5598,
            lng: 126.9368,
        },
        {
            id: 5,
            name: "ìŠ¤íƒ€ë²…ìŠ¤ í™ëŒ€ì…êµ¬ì—­ì ",
            address: "ì„œìš¸ ë§ˆí¬êµ¬ ì–‘í™”ë¡œ 160",
            lat: 37.5572,
            lng: 126.9238,
        },
        {
            id: 6,
            name: "ìŠ¤íƒ€ë²…ìŠ¤ ì ì‹¤ì—­ì ",
            address: "ì„œìš¸ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 265",
            lat: 37.5130,
            lng: 127.1002,
        },
        {
            id: 7,
            name: "ìŠ¤íƒ€ë²…ìŠ¤ ê±´ëŒ€ì…êµ¬ì ",
            address: "ì„œìš¸ ê´‘ì§„êµ¬ ëŠ¥ë™ë¡œ 92",
            lat: 37.5404,
            lng: 127.0692,
        },
        {
            id: 8,
            name: "ìŠ¤íƒ€ë²…ìŠ¤ ì‹œì²­ì—­ì ",
            address: "ì„œìš¸ ì¤‘êµ¬ ì„¸ì¢…ëŒ€ë¡œ 110",
            lat: 37.5659,
            lng: 126.9770,
        },
        {
            id: 9,
            name: "ìŠ¤íƒ€ë²…ìŠ¤ ì„œìš¸ì—­ì ",
            address: "ì„œìš¸ ìš©ì‚°êµ¬ í•œê°•ëŒ€ë¡œ 405",
            lat: 37.5551,
            lng: 126.9707,
        },
        {
            id: 10,
            name: "ìŠ¤íƒ€ë²…ìŠ¤ ì••êµ¬ì •ë¡œë°ì˜¤ì ",
            address: "ì„œìš¸ ê°•ë‚¨êµ¬ ì–¸ì£¼ë¡œ 872",
            lat: 37.5273,
            lng: 127.0400,
        },
    ];

    // ===== 2. DOM ìš”ì†Œ =====
    const storeListEl = document.getElementById("store-list");
    const selectedOrderEl = document.getElementById("selected-order");
    const statusEl = document.getElementById("status");
    const routeInfoEl = document.getElementById("route-info");
    const clearBtn = document.getElementById("clear-btn");
    const orderRouteBtn = document.getElementById("order-route-btn");
    const shortestRouteBtn = document.getElementById("shortest-route-btn");

    // ì„ íƒ ìˆœì„œë¥¼ ê¸°ë¡í•˜ê¸° ìœ„í•œ ì¹´ìš´í„°
    let selectionCounter = 0;

    // ===== 3. ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ =====
    function renderStoreList() {
        storeListEl.innerHTML = "";
        stores.forEach((store) => {
            const item = document.createElement("div");
            item.className = "store-item";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.className = "store-checkbox";
            checkbox.dataset.storeId = store.id;

            // ì²´í¬/ì–¸ì²´í¬ ì‹œ ì„ íƒ ìˆœì„œ ê¸°ë¡ + ìš”ì•½ ëª©ë¡ ê°±ì‹ 
            checkbox.addEventListener("change", () => {
                if (checkbox.checked) {
                    if (!checkbox.dataset.selectedOrder) {
                        checkbox.dataset.selectedOrder = ++selectionCounter;
                    }
                } else {
                    delete checkbox.dataset.selectedOrder;
                }
                updateSelectedSummary();
            });

            const info = document.createElement("div");
            const nameEl = document.createElement("div");
            nameEl.className = "store-name";
            nameEl.textContent = store.name;

            const addrEl = document.createElement("div");
            addrEl.className = "store-addr";
            addrEl.textContent = store.address;

            info.appendChild(nameEl);
            info.appendChild(addrEl);

            item.appendChild(checkbox);
            item.appendChild(info);

            storeListEl.appendChild(item);
        });
    }

    renderStoreList();

    // ===== 4. ì§€ë„ ì´ˆê¸°í™” =====
    const map = L.map("map").setView([37.56, 126.98], 12); // ì„œìš¸ ì¤‘ì‹¬
    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {}).addTo(map);

    // ë§¤ì¥ ê¸°ë³¸ ë§ˆì»¤ í‘œì‹œ (ì „ì²´ 10ê°œ)
    const storeMarkers = [];
    stores.forEach((s) => {
        const marker = L.marker([s.lat, s.lng]).addTo(map);
        marker.bindPopup(`<b>${s.name}</b><br>${s.address}`);
        storeMarkers.push(marker);
    });

    // ë¼ìš°íŒ… ì»¨íŠ¸ë¡¤ ë° ê²½ë¡œìš© ë§ˆì»¤ ê´€ë¦¬
    let routingControl = null;
    let routeMarkers = [];

    // ===== 5. ì„ íƒëœ ë§¤ì¥ ê°€ì ¸ì˜¤ê¸° (í´ë¦­ ìˆœì„œ ê¸°ì¤€) =====
    function getSelectedStoresByClickOrder() {
        const checkboxes = Array.from(
            document.querySelectorAll(".store-checkbox")
        ).filter((cb) => cb.checked);

        if (checkboxes.length === 0) return [];

        checkboxes.sort((a, b) => {
            const orderA = parseInt(a.dataset.selectedOrder || "0", 10);
            const orderB = parseInt(b.dataset.selectedOrder || "0", 10);
            return orderA - orderB;
        });

        const selectedStores = checkboxes.map((cb) => {
            const id = parseInt(cb.dataset.storeId, 10);
            return stores.find((s) => s.id === id);
        });

        return selectedStores;
    }

    // ===== 6. í˜„ì¬ ì„ íƒ ìˆœì„œ ìš”ì•½ í‘œì‹œ =====
    function updateSelectedSummary() {
        const selectedStores = getSelectedStoresByClickOrder();
        if (selectedStores.length === 0) {
            selectedOrderEl.textContent = "ì„ íƒëœ ë§¤ì¥ì´ ì—†ìŠµë‹ˆë‹¤.";
            return;
        }
        const lines = selectedStores.map(
            (s, idx) => `${idx + 1}. ${s.name}`
        );
        selectedOrderEl.textContent = lines.join("\n");
    }

    updateSelectedSummary();

    // ===== 7. ì´ì „ ê²½ë¡œ/ë§ˆì»¤ ì •ë¦¬ =====
    function clearRoute() {
        if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
        }
        routeMarkers.forEach((m) => map.removeLayer(m));
        routeMarkers = [];
    }

    // ê¸°ë³¸ ë§¤ì¥ ë§ˆì»¤ë¥¼ ì§€ë„ì— ë‹¤ì‹œ ì¶”ê°€
    function showAllStoreMarkers() {
        storeMarkers.forEach((m) => {
            if (!map.hasLayer(m)) {
                m.addTo(map);
            }
        });
    }

    // ê¸°ë³¸ ë§¤ì¥ ë§ˆì»¤ë¥¼ ëª¨ë‘ ì œê±°
    function hideAllStoreMarkers() {
        storeMarkers.forEach((m) => {
            if (map.hasLayer(m)) {
                map.removeLayer(m);
            }
        });
    }

    // ===== 8. ì£¼ì–´ì§„ ìˆœì„œëŒ€ë¡œ ê²½ë¡œ ê·¸ë¦¬ê¸° (ì½œë°±ìœ¼ë¡œ í›„ì²˜ë¦¬) =====
    function drawRouteForStores(storeSequence, onDone) {
        clearRoute();

        if (storeSequence.length < 2) {
            alert("ìµœì†Œ 2ê°œ ì´ìƒì˜ ë§¤ì¥ì„ ì„ íƒí•´ì•¼ ê²½ë¡œë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        // ğŸ”´ ê²½ë¡œ íƒìƒ‰ ì‹œ: ê¸°ë³¸ 10ê°œ ë§¤ì¥ ë§ˆì»¤ëŠ” ì œê±°
        hideAllStoreMarkers();

        // ğŸ”´ ì‹¤ì œ ì´ë™ ê²½ë¡œì— í¬í•¨ëœ ë§¤ì¥ë§Œ ë²ˆí˜¸ ë§ˆì»¤ë¡œ í‘œì‹œ (ê³ ì •)
        storeSequence.forEach((s, idx) => {
            const icon = L.divIcon({
                className: "route-index",
                html: String(idx + 1),
                iconSize: [24, 24],
                iconAnchor: [12, 12],
            });

            const marker = L.marker([s.lat, s.lng], { icon }).addTo(map);
            marker.bindPopup(
                `<b>${idx + 1}. ${s.name}</b><br>${s.address}`
            );
            routeMarkers.push(marker);
        });

        routingControl = L.Routing.control({
            waypoints: storeSequence.map((s) => L.latLng(s.lat, s.lng)),
            routeWhileDragging: false,
            addWaypoints: false,
            draggableWaypoints: false,
            showAlternatives: false,
            lineOptions: {
                styles: [
                    { color: "#3388ff", opacity: 0.8, weight: 4 }
                ],
            },
        })
            .on("routesfound", (e) => {
                const route = e.routes[0];
                if (route && route.bounds) {
                    map.fitBounds(route.bounds, { padding: [40, 40] });
                }
                statusEl.textContent = "ê²½ë¡œ ê³„ì‚° ì™„ë£Œ!";
                if (onDone) onDone(route);
            })
            .addTo(map);
    }

    // ===== 9. ìµœë‹¨ ê±°ë¦¬ ê²½ë¡œ ê³„ì‚° (TSP: ì‹œì‘ì ì€ ì²« ì„ íƒ ê³ ì •) =====
    function computeShortestPathOrder(selectedStores) {
        const n = selectedStores.length;
        if (n < 2) return selectedStores;

        const points = selectedStores.map((s) => L.latLng(s.lat, s.lng));
        const dist = Array.from({ length: n }, () => Array(n).fill(0));

        for (let i = 0; i < n; i++) {
            for (let j = i + 1; j < n; j++) {
                const d = map.distance(points[i], points[j]);
                dist[i][j] = d;
                dist[j][i] = d;
            }
        }

        const m = n - 1;
        const size = 1 << m;
        const INF = Number.POSITIVE_INFINITY;

        const dp = Array.from({ length: size }, () =>
            Array(n).fill(INF)
        );
        const parent = Array.from({ length: size }, () =>
            Array(n).fill(-1)
        );

        for (let j = 1; j < n; j++) {
            const mask = 1 << (j - 1);
            dp[mask][j] = dist[0][j];
            parent[mask][j] = 0;
        }

        for (let mask = 1; mask < size; mask++) {
            for (let j = 1; j < n; j++) {
                if (!(mask & (1 << (j - 1)))) continue;
                const prevMask = mask ^ (1 << (j - 1));
                if (prevMask === 0) continue;

                for (let k = 1; k < n; k++) {
                    if (!(prevMask & (1 << (k - 1)))) continue;
                    const candidate = dp[prevMask][k] + dist[k][j];
                    if (candidate < dp[mask][j]) {
                        dp[mask][j] = candidate;
                        parent[mask][j] = k;
                    }
                }
            }
        }

        const fullMask = size - 1;
        let bestCost = INF;
        let endNode = -1;
        for (let j = 1; j < n; j++) {
            if (dp[fullMask][j] < bestCost) {
                bestCost = dp[fullMask][j];
                endNode = j;
            }
        }

        const orderIndices = [];
        let mask = fullMask;
        let cur = endNode;
        while (cur !== 0 && cur !== -1) {
            orderIndices.push(cur);
            const prev = parent[mask][cur];
            mask = mask ^ (1 << (cur - 1));
            cur = prev;
        }
        orderIndices.push(0);
        orderIndices.reverse();

        const orderedStores = orderIndices.map((idx) => selectedStores[idx]);
        return orderedStores;
    }

    // ===== 10. ë²„íŠ¼ ì´ë²¤íŠ¸ =====

    // ì„ íƒ í•´ì œ
    clearBtn.addEventListener("click", () => {
        document
            .querySelectorAll(".store-checkbox")
            .forEach((cb) => {
                cb.checked = false;
                delete cb.dataset.selectedOrder;
            });
        selectionCounter = 0;
        clearRoute();
        updateSelectedSummary();
        statusEl.textContent = "ëª¨ë“  ì„ íƒì„ í•´ì œí–ˆìŠµë‹ˆë‹¤.";
        routeInfoEl.textContent = "";

        // ğŸ”„ ì „ì²´ ë§¤ì¥ ê¸°ë³¸ ë§ˆì»¤ ë‹¤ì‹œ ë³´ì—¬ì£¼ê¸°
        showAllStoreMarkers();
    });

    // ì„ íƒ ìˆœì„œëŒ€ë¡œ ê²½ë¡œ
    orderRouteBtn.addEventListener("click", () => {
        const selectedStores = getSelectedStoresByClickOrder();
        if (selectedStores.length < 2) {
            alert("ìµœì†Œ 2ê°œ ì´ìƒì˜ ë§¤ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }
        statusEl.textContent = "ì„ íƒ ìˆœì„œëŒ€ë¡œ ê²½ë¡œë¥¼ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...";
        drawRouteForStores(selectedStores, () => {
            const lines = selectedStores.map(
                (s, idx) => `${idx + 1}. ${s.name}`
            );
            routeInfoEl.textContent =
                "ì„ íƒ ìˆœì„œëŒ€ë¡œ ì´ë™ ê²½ë¡œ:\n" + lines.join("\n");
        });
    });

    // ìµœë‹¨ ê±°ë¦¬ ê²½ë¡œ
    shortestRouteBtn.addEventListener("click", () => {
        const selectedStores = getSelectedStoresByClickOrder();
        if (selectedStores.length < 2) {
            alert("ìµœì†Œ 2ê°œ ì´ìƒì˜ ë§¤ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }
        statusEl.textContent = "ìµœë‹¨ ê±°ë¦¬ ê²½ë¡œë¥¼ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...";

        const orderedStores = computeShortestPathOrder(selectedStores);
        drawRouteForStores(orderedStores, () => {
            const origLines = selectedStores.map(
                (s, idx) => `${idx + 1}. ${s.name}`
            );
            const shortLines = orderedStores.map(
                (s, idx) => `${idx + 1}. ${s.name}`
            );
            routeInfoEl.textContent =
                "ì›ë˜ ì„ íƒ ìˆœì„œ:\n" +
                origLines.join("\n") +
                "\n\nìµœë‹¨ ê±°ë¦¬ ìˆœì„œ:\n" +
                shortLines.join("\n");
        });
    });
</script>
</body>
</html>
