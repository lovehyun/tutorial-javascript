<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Key</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="/">SaaS Service</a>
        <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-target="#navbarNav"
            aria-controls="navbarNav"
            aria-expanded="false"
            aria-label="Toggle navigation"
        >
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/register.html">Register</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/login.html" id="loginLink">Login</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/apikey.html">API Key</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/snippet.html">Snippet</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logs.html">Logs</a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="content">
        <h1>Your API Key</h1>
        <ul id="apikeys"></ul>
        <button id="generateApiKey">Generate New API Key</button>
        <script>
            function fetchApiKeys() {
                fetch('/apikeys', {
                    method: 'GET',
                    headers: {
                        'x-auth': localStorage.getItem('token'),
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        return window.handleError(response);
                    }
                    return response.json();
                })
                .then(data => {
                    const apikeysList = document.getElementById('apikeys');
                    apikeysList.innerHTML = ''; // Clear existing list
                    data.apiKeys.forEach(apiKey => {
                        const li = document.createElement('li');
                        li.textContent = apiKey;
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.className = 'btn btn-danger btn-sm ml-2';
                        deleteButton.addEventListener('click', () => deleteApiKey(apiKey));
                        li.appendChild(deleteButton);
                        apikeysList.appendChild(li);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error);
                });
            }

            function generateApiKey() {
                fetch('/apikey', {
                    method: 'POST',
                    headers: {
                        'x-auth': localStorage.getItem('token'),
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        return window.handleError(response);
                    }
                    return response.json();
                })
                .then(() => fetchApiKeys()) // Refresh the list after generating
                .catch(error => {
                    console.error('Error:', error);
                    alert(error);
                });
            }

            function deleteApiKey(apiKey) {
                fetch('/apikey', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth': localStorage.getItem('token'),
                    },
                    body: JSON.stringify({ apiKey }),
                })
                .then(response => {
                    if (!response.ok) {
                        return window.handleError(response);
                    }
                    return response.json();
                })
                .then(() => fetchApiKeys()) // Refresh the list after deletion
                .catch(error => console.error('Error:', error));
            }

            document.getElementById('generateApiKey').addEventListener('click', generateApiKey);
            document.addEventListener('DOMContentLoaded', fetchApiKeys);
        </script>
    </div>
    <script src="/js/auth.js"></script>
</body>
</html>
