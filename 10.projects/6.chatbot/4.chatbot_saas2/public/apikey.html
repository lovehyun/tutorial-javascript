<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Key</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="/">SaaS Service</a>
        <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-target="#navbarNav"
            aria-controls="navbarNav"
            aria-expanded="false"
            aria-label="Toggle navigation"
        >
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/register.html">Register</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/login.html" id="loginLink">Login</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/apikey.html">API Key</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/snippet.html">Snippet</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logs.html">Logs</a>
                </li>
            </ul>
        </div>
    </nav>
     <!-- 사용자 정보를 표시할 요소 추가 -->
     <div id="accountInfo" class="alert alert-info" style="margin: 20px;">
        Not logged in. Please log in to view your account information.
    </div>

    <!-- 키 정보를 표시할 요소 추가 -->
    <div class="content">
        <h1>Your API Key</h1>
        <ul id="apikeys"></ul>
        <div>
            <input type="text" id="apiKeyTitle" placeholder="Enter API Key Title" />
            <button id="generateApiKey">Generate New API Key</button>
        </div>
        <script>
            function fetchApiKeys() {
                fetch('/apikeys', {
                    method: 'GET',
                    headers: {
                        'x-auth': localStorage.getItem('token'),
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        return window.handleError(response);
                    }
                    return response.json();
                })
                .then(data => {
                    const apikeysList = document.getElementById('apikeys');
                    apikeysList.innerHTML = ''; // Clear existing list
                    
                    // Check if data is an array and has keys
                if (Array.isArray(data) && data.length > 0) {
                    data.forEach(apiKey => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <strong>${apiKey.title}</strong>: ${apiKey.key}
                            <button class="btn btn-warning btn-sm ml-2 edit-button">Edit</button>
                            <button class="btn btn-danger btn-sm ml-2 delete-button">Delete</button>
                        `;

                        const editButton = li.querySelector('.edit-button');
                        const deleteButton = li.querySelector('.delete-button');

                        editButton.addEventListener('click', () => editApiKeyTitle(apiKey.key, apiKey.title));
                        deleteButton.addEventListener('click', () => deleteApiKey(apiKey.key));

                        apikeysList.appendChild(li);
                    });
                    } else {
                        // If no keys, display a placeholder message
                        const li = document.createElement('li');
                        li.textContent = 'No API keys available. Please generate one.';
                        apikeysList.appendChild(li);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to fetch API keys.');
                });
            }

            function generateApiKey() {
                const title = document.getElementById('apiKeyTitle').value.trim();
                if (!title) {
                    alert('Please enter a title for the API key.');
                    return;
                }
                
                fetch('/apikeys', {
                    method: 'POST',
                    headers: {
                        'x-auth': localStorage.getItem('token'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ title }),
                })
                .then(response => {
                    if (!response.ok) {
                        return window.handleError(response);
                    }
                    return response.json();
                })
                .then(() => {
                    fetchApiKeys(); // Refresh the list after generating
                    document.getElementById('apiKeyTitle').value = ''; // Clear input
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error);
                });
            }

            function deleteApiKey(apiKey) {
                fetch('/apikeys', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth': localStorage.getItem('token'),
                    },
                    body: JSON.stringify({ apiKey }),
                })
                .then(response => {
                    if (!response.ok) {
                        return window.handleError(response);
                    }
                    return response.json();
                })
                .then(() => fetchApiKeys()) // Refresh the list after deletion
                .catch(error => console.error('Error:', error));
            }

            function editApiKeyTitle(apiKey, currentTitle) {
            const newTitle = prompt('Enter a new title:', currentTitle);
            if (!newTitle || newTitle.trim() === currentTitle) {
                alert('No changes made.');
                return;
            }

            fetch('/apikeys/title', {
                method: 'PATCH',
                headers: {
                    'x-auth': localStorage.getItem('token'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ apiKey, newTitle: newTitle.trim() }),
            })
                .then(response => {
                    if (!response.ok) {
                        return window.handleError(response);
                    }
                    return response.json();
                })
                .then(() => fetchApiKeys()) // Refresh the list after editing
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update API key title.');
                });
            }

            document.getElementById('generateApiKey').addEventListener('click', generateApiKey);
            document.addEventListener('DOMContentLoaded', fetchApiKeys);
        </script>
    </div>
    <script src="/js/auth.js"></script>
</body>
</html>
