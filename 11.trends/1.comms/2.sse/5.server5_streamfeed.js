// server.js
const express = require('express');
const cors = require('cors');
const path = require('path');

const app = express();
app.use(express.json());
app.use(cors());

// ì •ì  íŒŒì¼ ì œê³µ (í”„ë¡ íŠ¸ HTML)
app.use(express.static(path.join(__dirname, 'public')));

// í•˜ë“œì½”ë”©ëœ ë‰´ìŠ¤ ê¸°ì‚¬ ëª©ë¡ (ê¸´ ë¬¸ìž¥ ì—¬ëŸ¬ ê°œ)
const newsFeed = [
    {
        title: 'AI ê¸°ë°˜ ê°œì¸ ì—…ë¬´ë¹„ì„œ ì„œë¹„ìŠ¤ ìƒìš©í™” ìž„ë°•',
        content:
            'ìƒì„±í˜• AIë¥¼ í™œìš©í•œ ê°œì¸ ì—…ë¬´ë¹„ì„œ ì„œë¹„ìŠ¤ê°€ ì¡°ë§Œê°„ ìƒìš©í™”ë  ì „ë§ìž…ë‹ˆë‹¤. \
ì´ë²ˆ ì„œë¹„ìŠ¤ëŠ” ì´ë©”ì¼ ì •ë¦¬, ì¼ì • ê´€ë¦¬, íšŒì˜ë¡ ìš”ì•½ ë¿ ì•„ë‹ˆë¼, ì˜ìˆ˜ì¦ ì •ë¦¬ì™€ ì„¸ë¬´ ê´€ë ¨ ë¬¸ì„œê¹Œì§€ ìžë™ìœ¼ë¡œ ë¶„ë¥˜í•´ì£¼ëŠ” ê¸°ëŠ¥ì„ íƒ‘ìž¬í–ˆìŠµë‹ˆë‹¤.',
    },
    {
        title: 'êµ­ë‚´ ìŠ¤íƒ€íŠ¸ì—…, ë©€í‹°ëª¨ë‹¬ AIë¡œ ê¸€ë¡œë²Œ ì‹œìž¥ ë„ì „',
        content:
            'êµ­ë‚´ í•œ ìŠ¤íƒ€íŠ¸ì—…ì´ ì´ë¯¸ì§€Â·ìŒì„±Â·í…ìŠ¤íŠ¸ë¥¼ ë™ì‹œì— ì´í•´í•˜ëŠ” ë©€í‹°ëª¨ë‹¬ AI ê¸°ìˆ ì„ ì•žì„¸ì›Œ \
ê¸€ë¡œë²Œ ì‹œìž¥ì— ë„ì „ìž¥ì„ ë‚´ë°€ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìžëŠ” ì‚¬ì§„ì„ ì°ê±°ë‚˜ ìŒì„±ìœ¼ë¡œ ì„¤ëª…í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œë„ \
ê³„ì•½ì„œ ê²€í† , ë²•ë¥  ë¬¸ì„œ ìš”ì•½, íšŒê³„ ìžë£Œ ë¶„ì„ ë“±ì˜ ë³µìž¡í•œ ì—…ë¬´ë¥¼ ì†ì‰½ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìžˆê²Œ ë©ë‹ˆë‹¤.',
    },
    {
        title: 'ë³´ì•ˆ ì—…ê³„, AI ê¸°ë°˜ ê³µê²©Â·ë°©ì–´ ì—ì´ì „íŠ¸ ê²½ìŸ ì¹˜ì—´',
        content:
            'ë³´ì•ˆ ì—…ê³„ì—ì„œëŠ” AI ì—ì´ì „íŠ¸ë¥¼ í™œìš©í•œ ê³µê²©Â·ë°©ì–´ ì‹œë®¬ë ˆì´ì…˜ ê¸°ìˆ  ê²½ìŸì´ ì¹˜ì—´í•´ì§€ê³  ìžˆìŠµë‹ˆë‹¤. \
ê³µê²© ì—ì´ì „íŠ¸ëŠ” ì‹¤ì œ í•´í‚¹ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìžë™ìœ¼ë¡œ ìƒì„±í•˜ê³ , ë°©ì–´ ì—ì´ì „íŠ¸ëŠ” ì‹¤ì‹œê°„ìœ¼ë¡œ ì´ë¥¼ íƒì§€í•˜ê³  ì°¨ë‹¨í•˜ëŠ” ì „ëžµì„ í•™ìŠµí•©ë‹ˆë‹¤. \
ì´ë¥¼ í†µí•´ ê¸°ì—…ë“¤ì€ ë³´ë‹¤ í˜„ì‹¤ì ì¸ ëª¨ì˜ ì¹¨íˆ¬ í…ŒìŠ¤íŠ¸ì™€ ëŒ€ì‘ ì „ëžµ ìˆ˜ë¦½ì´ ê°€ëŠ¥í•´ì§ˆ ì „ë§ìž…ë‹ˆë‹¤.',
    },
    {
        title: 'í´ë¼ìš°ë“œ ì¸í”„ë¼ ë¹„ìš© ìµœì í™”, ì¤‘ì†Œê¸°ì—…ì˜ ìƒˆë¡œìš´ ê³¼ì œ',
        content:
            'ì¤‘ì†Œê¸°ì—…ë“¤ì´ AI ì„œë¹„ìŠ¤ë¥¼ ì ê·¹ì ìœ¼ë¡œ ë„ìž…í•˜ë©´ì„œ, í´ë¼ìš°ë“œ ì¸í”„ë¼ ë¹„ìš© ìµœì í™”ê°€ ì¤‘ìš”í•œ ê³¼ì œë¡œ ë– ì˜¤ë¥´ê³  ìžˆìŠµë‹ˆë‹¤. \
ì „ë¬¸ê°€ë“¤ì€ ì„œë²„ë¦¬ìŠ¤ ì•„í‚¤í…ì²˜, ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤ í™œìš©, ìŠ¤í† ë¦¬ì§€ ê³„ì¸µ ë¶„ë¦¬ ë“±ì„ í†µí•´ ë¹„ìš©ì„ ì ˆê°í•  ìˆ˜ ìžˆë‹¤ê³  ì¡°ì–¸í•©ë‹ˆë‹¤. \
ë˜í•œ ëª¨ë‹ˆí„°ë§ê³¼ ìžë™ ìŠ¤ì¼€ì¼ë§ ì •ì±…ì„ í•¨ê»˜ ì„¤ê³„í•˜ëŠ” ê²ƒì´ í•µì‹¬ì´ë¼ê³  ê°•ì¡°í•©ë‹ˆë‹¤.',
    },
];

// SSE ì—”ë“œí¬ì¸íŠ¸: /news-stream
app.get('/news-stream', (req, res) => {
    console.log('ðŸ”Œ [SSE] í´ë¼ì´ì–¸íŠ¸ ë‰´ìŠ¤ ìŠ¤íŠ¸ë¦¼ ì—°ê²°ë¨');

    // SSE ê¸°ë³¸ í—¤ë” ì„¤ì •
    res.setHeader('Content-Type', 'text/event-stream; charset=utf-8');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');

    // ì¦‰ì‹œ í”ŒëŸ¬ì‹œìš©(ì¼ë¶€ ì„œë²„ì—ì„œ í•„ìš”)
    res.flushHeaders && res.flushHeaders();

    // í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì²˜ìŒì— ê°„ë‹¨í•œ ì•ˆë‚´ ë©”ì‹œì§€
    res.write(`event: info\ndata: ${JSON.stringify({ message: 'ë‰´ìŠ¤ ìŠ¤íŠ¸ë¦¼ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.' })}\n\n`);

    let index = 0;

    // 2ì´ˆë§ˆë‹¤ í•œ â€œë‰´ìŠ¤ ë¸”ë¡â€ì”© ë³´ë‚´ê¸° (ì±„íŒ…ì²˜ëŸ¼)
    const intervalId = setInterval(() => {
        if (index >= newsFeed.length) {
            // ëª¨ë“  ë‰´ìŠ¤ë¥¼ ë‹¤ ë³´ëƒˆìœ¼ë©´ ì¢…ë£Œ ë©”ì‹œì§€ ì „ì†¡ í›„ ì—°ê²° ì¢…ë£Œ (ì„ íƒ ì‚¬í•­)
            res.write(`event: end\ndata: ${JSON.stringify({ message: 'ë” ì´ìƒ ì „ì†¡í•  ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.' })}\n\n`);
            console.log('âœ… [SSE] ëª¨ë“  ë‰´ìŠ¤ ì „ì†¡ ì™„ë£Œ, ì—°ê²° ì¢…ë£Œ');
            clearInterval(intervalId);
            res.end();
            return;
        }

        const news = newsFeed[index];

        // ì—¬ê¸°ì„œ title, contentë¥¼ ë‚˜ëˆ ì„œ ë‘ ë²ˆì— ë‚˜ëˆ  ë³´ë‚´ë„ ë˜ê³ ,
        // í•œ ë²ˆì— ë³´ë‚´ë„ ë˜ê³ , ì›í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ â€œì±„íŒ…ì²˜ëŸ¼â€ ìª¼ê°¤ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
        const payload = {
            type: 'news',
            index,
            title: news.title,
            content: news.content,
            timestamp: new Date().toISOString(),
        };

        console.log(`[SSE] ë‰´ìŠ¤ ì „ì†¡ index=${index} title=${news.title}`);
        res.write(`data: ${JSON.stringify(payload)}\n\n`);

        index += 1;
    }, 2000); // 2ì´ˆ ê°„ê²©

    // í´ë¼ì´ì–¸íŠ¸ê°€ ì—°ê²°ì„ ëŠì—ˆì„ ë•Œ
    req.on('close', () => {
        console.log('âŒ [SSE] í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì¢…ë£Œ');
        clearInterval(intervalId);
    });
});

// ê¸°ë³¸ íŽ˜ì´ì§€: / -> news.htmlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ê±°ë‚˜ ê·¸ëŒ€ë¡œ ì œê³µ
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', '5.stream.html'));
});

const PORT = 3000;
app.listen(PORT, () => {
    console.log(`SSE ë‰´ìŠ¤ ì„œë²„ ì‹¤í–‰ ì¤‘: http://localhost:${PORT}`);
});
