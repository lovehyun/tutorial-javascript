<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger Chat with Read Receipts</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background: #f0f2f5; 
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #chatContainer { 
            width: 400px; 
            height: 90vh; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column;
            overflow: hidden;
        }
        #messages { 
            flex: 1; 
            padding: 10px; 
            margin: 0; 
            list-style: none; 
            overflow-y: auto;
        }
        #messages li { 
            margin-bottom: 10px; 
            position: relative; 
        }
        #inputContainer { 
            display: flex; 
            padding: 10px; 
            border-top: 1px solid #ddd;
            position: sticky; /* í•­ìƒ í•˜ë‹¨ ê³ ì • */
            bottom: 0;
            background: white;
            gap: 5px; /* ê° ì…ë ¥ í•„ë“œ ê°„ ì—¬ë°± ì¶”ê°€ */
        }
        /* ì…ë ¥ì¹¸ ìŠ¤íƒ€ì¼ ìˆ˜ì • (í…Œë‘ë¦¬ + ê·¸ë¦¼ì) */
        #usernameInput, #messageInput { 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 20px; 
            outline: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* ê·¸ë¦¼ì ì¶”ê°€ */
        }
        /* í¬ì»¤ìŠ¤ ì‹œ ê°•ì¡° */
        #usernameInput:focus, #messageInput:focus { 
            border-color: #007BFF;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.7);
        }
        #usernameInput { 
            width: 20%; 
            padding: 10px; 
            border: none; 
            border-radius: 20px; 
            outline: none;
        }
        #messageInput { 
            flex: 1; 
            padding: 10px; 
            border: none; 
            border-radius: 20px; 
            outline: none;
        }
        button { 
            padding: 10px 15px; 
            border: none; 
            background: #007BFF; 
            color: white; 
            border-radius: 20px; 
            cursor: pointer;
            white-space: nowrap; /* ë²„íŠ¼ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }
        button:hover { background: #0056b3; }
        
        /* ë§í’ì„  ë””ìì¸ ê°œì„  */
        .myMessage { text-align: right; }
        .myMessage .bubble { 
            background: #007BFF; 
            color: white; 
            border-radius: 15px 15px 0 15px; 
            padding: 10px; 
            display: inline-block;
        }
        .otherMessage { text-align: left; }
        .otherMessage .bubble { 
            background: #EAEAEA; 
            border-radius: 15px 15px 15px 0; 
            padding: 10px; 
            display: inline-block;
        }

        /* ì½ìŒ ì¹´ìš´íŠ¸ (ë§í’ì„  ì˜¤ë¥¸ìª½) */
        .readCount { 
            font-size: 0.8rem; 
            color: gray; 
            position: absolute;
            bottom: 0; 
        }
        /* ë‚´ ë©”ì‹œì§€ì¸ ê²½ìš° ì˜¤ë¥¸ìª½ìœ¼ë¡œ */
        .myMessage .readCount {
            right: -10px;
        }
        /* ìƒëŒ€ ë©”ì‹œì§€ì¸ ê²½ìš° ì˜¤ë¥¸ìª½ìœ¼ë¡œ */
        .otherMessage .readCount {
            left: -10px;
        }
        .typing { 
            color: gray; 
            font-style: italic; 
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="chatContainer">
        <h1 style="text-align: center; margin: 10px 0;">Messenger Chat with Read Receipts</h1>
        <ul id="messages"></ul>
        <p class="typing" id="typingIndicator"></p>
        <div id="inputContainer">
            <input id="usernameInput" placeholder="Name" required>
            <input id="messageInput" autocomplete="off" placeholder="Type a message..." required>
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <!-- Socket.IO ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let username = '';
        let typingUsers = []; // ì—¬ëŸ¬ ì‚¬ìš©ì íƒ€ì´í•‘ ì¶”ì ì„ ìœ„í•œ ë°°ì—´
        let totalUsers = 0;

        const usernameInput = document.getElementById('usernameInput');
        const messageInput = document.getElementById('messageInput');
        const messages = document.getElementById('messages');
        const typingIndicator = document.getElementById('typingIndicator');

        // ì„œë²„ë¡œë¶€í„° ì†Œì¼“ IDë¥¼ ìˆ˜ì‹ í•˜ê³  ì €ì¥
        socket.on('connect', () => {
            console.log(`ğŸ”— Connected with socket ID: ${socket.id}`);
        });

        // ì‚¬ìš©ìëª… ì„¤ì •
        usernameInput.addEventListener('change', () => {
            username = usernameInput.value;
            socket.emit('user joined', username);
        });

        // íƒ€ì´í•‘ í‘œì‹œ
        messageInput.addEventListener('input', () => {
            socket.emit('typing');
        });

        messageInput.addEventListener('blur', () => {
            socket.emit('stop typing');
        });

        // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡ ê°€ëŠ¥í•˜ë„ë¡ ì¶”ê°€
        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // ë©”ì‹œì§€ ì „ì†¡ ë° ì½ìŒ ìƒíƒœ ì´ˆê¸°í™”
        function sendMessage() {
            const message = messageInput.value;
            if (!username) {
                alert('Please enter your name first.');
                return;
            }
            if (message.trim()) {
                const timestamp = Date.now();
                appendMessage(`You: ${message}`, 'myMessage', totalUsers - 1, timestamp); // ë‚˜ë¥¼ ì œì™¸í•˜ê³  Unread ì¹´ìš´íŠ¸ ì…‹ì—…
                socket.emit('chat message', { username, message, timestamp });
                messageInput.value = '';
                scrollToBottom();
            }
        }

        // ë©”ì‹œì§€ ìˆ˜ì‹ 
        socket.on('chat message', ({ username: sender, message, timestamp, unreadUsers }) => {
            if (sender !== username) {
                console.log(`ë©”ì‹œì§€ìˆ˜ì‹ : ${message} (${unreadUsers.length}) ${unreadUsers}`)
                appendMessage(`${sender}: ${message}`, 'otherMessage', unreadUsers.length, timestamp);
            }
            scrollToBottom();
        });

        // íƒ€ì´í•‘ í‘œì‹œ ìˆ˜ì‹ 
        socket.on('typing', (typingUser) => {
            if (!typingUsers.includes(typingUser)) {
                typingUsers.push(typingUser);
            }
            updateTypingIndicator();
        });

        socket.on('stop typing', (typingUser) => {
            typingUsers = typingUsers.filter(user => user !== typingUser);
            updateTypingIndicator();
        });

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateTypingIndicator() {
            if (typingUsers.length > 0) {
                typingIndicator.textContent = `${typingUsers.join(', ')} is typing...`;
            } else {
                typingIndicator.textContent = '';
            }
        }

        // í¬ì»¤ìŠ¤ ì‹œ, ì½ì§€ ì•Šì€ ë©”ì‹œì§€ì— ëŒ€í•´ ì„œë²„ë¡œ ì•Œë¦¼
        window.addEventListener('focus', () => {
            const unreadMessages = document.querySelectorAll('.readCount');
            unreadMessages.forEach((element) => {
                const messageTimestamp = element.getAttribute('data-timestamp');
                socket.emit('read message', { timestamp: messageTimestamp });
            });
        });

        // ì½ìŒ í™•ì¸ ì—…ë°ì´íŠ¸
        socket.on('update read receipt', ({ timestamp, unreadUsers }) => {
            const readCountElement = document.querySelector(`.readCount[data-timestamp="${timestamp}"]`);
            console.log(`ìˆ˜ì‹ ë©”ì‹œì§€(ì½ìŒ): ${timestamp}, ì•ˆì½ì€ì‚¬ìš©ì: ${unreadUsers}`)
            if (readCountElement) {
                readCountElement.innerText = unreadUsers.length;
            }
        });

        socket.on('user count', (count) => {
            totalUsers = count;
        });

        // ë§í’ì„  ë©”ì‹œì§€ ì¶”ê°€ (ì½ìŒ ìˆ˜ í¬í•¨)
        function appendMessage(message, className, unreadCount, timestamp) {
            const li = document.createElement('li');
            li.className = className;
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.textContent = message;

            const readCount = document.createElement('span');
            readCount.className = 'readCount';
            readCount.textContent = unreadCount;
            readCount.setAttribute('data-timestamp', timestamp);
            
            li.appendChild(bubble);
            li.appendChild(readCount);
            messages.appendChild(li);
        }

        // í•­ìƒ ìŠ¤í¬ë¡¤ì„ ì•„ë˜ë¡œ ìœ ì§€
        function scrollToBottom() {
            messages.scrollTop = messages.scrollHeight;
        }
    </script>
</body>
</html>
