<!-- views/cart.html -->
{% extends "layout.html" %}
{% block title %}Cart Page{% endblock %}

{% block head %}
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        button {
            cursor: pointer;
        }

        .quantity {
            width: 30px;
            text-align: center;
        }

        tfoot tr {
            background-color: #f2f2f2;
        }

        .total {
            font-weight: bold;
        }
    </style>
{% endblock %}

{% block content %}
    <h2>장바구니</h2>
    <table id="cartTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr id="emptyCartMessageRow" style="display: none">
                <td colspan="5" style="background-color: #fff; text-align: center">장바구니가 비었습니다.</td>
            </tr>
            <tr>
                <td colspan="3"></td>
                <td>Total:</td>
                <td id="totalAmount" class="total"></td>
            </tr>
        </tfoot>
    </table>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            fetch('/api/cart')
                .then((response) => response.json())
                .then((cartData) => displayCart(cartData));

            function displayCart(cartData) {
                const cart = cartData.cart || [];
                const cartTableBody = document.querySelector('#cartTable tbody');
                const totalAmountSpan = document.querySelector('#totalAmount');

                // 초기화
                cartTableBody.innerHTML = '';
                emptyCartMessageRow.style.display = 'none';

                if (cart.length === 0) {
                    emptyCartMessageRow.style.display = 'table-row';
                }

                let totalAmount = 0;

                cart.forEach((item) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                                <td>${item.id}</td>
                                <td>${item.name}</td>
                                <td>${item.price}</td>
                                <td>
                                    <span class="quantity" id="quantity-${item.id}">${item.quantity}</span>
                                    <button onclick="increaseQuantity(${item.id})">+</button>
                                    <button onclick="decreaseQuantity(${item.id})">-</button>
                                </td>
                                <td><button onclick="removeFromCart(${item.id})">Remove</button></td>
                                `;
                    cartTableBody.appendChild(row);
                    totalAmount += item.price * item.quantity;
                });

                totalAmountSpan.textContent = totalAmount;
            }

            window.increaseQuantity = function (productId) {
                updateQuantity(productId, 1);
            };

            window.decreaseQuantity = function (productId) {
                updateQuantity(productId, -1);
            };

            function updateQuantity(productId, change) {
                fetch(`/api/cart/${productId}?change=${change}`, { method: 'PUT' })
                    .then((response) => response.json())
                    .then((cartData) => {
                        sessionStorage.setItem('cart', JSON.stringify(cartData.cart));
                        displayCart(cartData);
                    });
            }

            window.removeFromCart = function (productId) {
                fetch(`/api/cart/${productId}`, { method: 'DELETE' })
                    .then((response) => response.json())
                    .then((cartData) => {
                        sessionStorage.setItem('cart', JSON.stringify(cartData.cart));
                        displayCart(cartData);
                    });
            };
        });
    </script>
{% endblock %}
